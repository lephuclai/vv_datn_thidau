<!doctype html><html lang="vi"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>B√†i thi</title>
<link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;700;800&display=swap&subset=vietnamese" rel="stylesheet">
<!-- keep your original look -->
<style>
  :root{ --font:"Be Vietnam Pro", system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif }
  body{ margin:0; background:#f6f7fb; color:#444; font-family:var(--font); background: url("background-hoctiengviet.png") no-repeat top center;
  background-size: cover; }
  .box{ background:#fff; border:1px solid #eee; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.06); padding:14px; max-width:900px; margin:12px auto }
  .button{ font-family:var(--font); font-weight:800; padding:8px 14px; border-radius:10px; border:0; cursor:pointer }
  .btn-grey{ background:#44A5DC; color:#fff } .btn-outline{ background:#fff; border:1px solid #ccc }
  .choices{ display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:10px; margin-top:12px }
  .opt{ padding:12px 16px; border-radius:12px; color:#fff; border:0; font-weight:800; cursor:pointer }
  .c1{ background:#FF3859 } .c2{ background:#44A5DC } .c3{ background:#FFC200; color:#603 } .c4{ background:#65BF3B }
</style>
</head><body>
<div class="box">
  <div style="display:flex; justify-content:space-between; align-items:center">
    <h2>üìù B√†i thi</h2>
    <div>‚è±Ô∏è C√≤n l·∫°i: <b id="time">--:--</b></div>
  </div>
  <div id="qwrap">
    <div id="qtext" style="font-size:20px; font-weight:800"></div>
    <div id="choices" class="choices"></div>
    <div style="margin-top:12px; display:flex; gap:8px">
      <button id="skip" class="button btn-outline">B·ªè qua (kh√¥ng t√≠nh ƒëi·ªÉm)</button>
      <button id="finish" class="button btn-grey">N·ªôp b√†i</button>
    </div>
  </div>
  <div id="done" style="display:none; text-align:center">
    <h3>‚úÖ ƒê√£ n·ªôp b√†i</h3>
    <p id="result"></p>
  </div>
</div>

<script>
const API_BASE = 'http://localhost:8080';
const url = new URL(location.href);
const attempt_id = Number(url.searchParams.get('attempt'));
const token = url.searchParams.get('token');
const endISO = url.searchParams.get('end');
const ord = (url.searchParams.get('ord')||'').split(',').map(x=>Number(x)).filter(Boolean);

let idx = 0, score = 0, total = 0;
const timeEl = document.getElementById('time');
const qtext = document.getElementById('qtext');
const choicesEl = document.getElementById('choices');
const done = document.getElementById('done');
const qwrap = document.getElementById('qwrap');
const resultEl = document.getElementById('result');

function tick(){
  const now = new Date();
  const end = new Date(endISO);
  let s = Math.max(0, Math.floor((end - now)/1000));
  const m = String(Math.floor(s/60)).padStart(2,'0'), ss = String(s%60).padStart(2,'0');
  timeEl.textContent = `${m}:${ss}`;
  if(s<=0) return finish(true);
  requestAnimationFrame(tick);
}

async function loadNext(){
  const r = await fetch(API_BASE+'/api/attempts/next',{method:'POST',headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ attempt_id, token, order: ord, index: idx })
  });
  const j = await r.json();
  if(j.done){ return finish(false); }
  renderQ(j.question);
}

function renderQ(q){
  qtext.textContent = q.text;
  total += (q.points||1);
  choicesEl.innerHTML = '';
  if(q.type === 'mcq'){
    q.choices.forEach((c,i)=>{
      const b = document.createElement('button');
      b.className = `opt c${(i%4)+1}`; b.textContent = c.label;
      b.onclick = ()=> answer(q.id, c.id, null);
      choicesEl.appendChild(b);
    });
  } else {
    const input = document.createElement('input');
    input.placeholder = 'Nh·∫≠p ƒë√°p √°n s·ªë'; input.style.padding='10px'; input.style.border='1px solid #ddd'; input.style.borderRadius='10px';
    const btn = document.createElement('button');
    btn.className = 'button btn-grey'; btn.textContent = 'Tr·∫£ l·ªùi';
    btn.onclick = ()=> answer(q.id, null, Number(input.value));
    choicesEl.appendChild(input); choicesEl.appendChild(btn);
  }
}

async function answer(qid, choice_id, numeric_answer){
  const r = await fetch(API_BASE+'/api/attempts/answer',{ method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ attempt_id, token, question_id: qid, choice_id, numeric_answer })
  });
  const j = await r.json();
  if(j.ok){ score = j.total; idx++; loadNext(); }
}
async function finish(auto){
  // lock UI
  document.getElementById('skip').disabled = true;
  document.getElementById('finish').disabled = true;
  await fetch(API_BASE+'/api/attempts/finish',{method:'POST',headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ attempt_id, token })
  });
  qwrap.style.display='none'; done.style.display='block';
  resultEl.textContent = `ƒêi·ªÉm c·ªßa b·∫°n: ${score} / ${total}`;
}

document.getElementById('skip').onclick = ()=>{ idx++; loadNext(); };
document.getElementById('finish').onclick = ()=> finish(false);
loadNext(); tick();
</script>
</body></html>
